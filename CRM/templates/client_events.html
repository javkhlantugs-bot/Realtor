<!-- client_events.html -->
{% extends 'base_event.html' %}

{% block title %}Infos for {{ client.client_name }} {% endblock %}

{% block content %}

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<style>
    #suggestionsTable td {
        background-color:rgba(0, 0, 0, 0); /* Set the background color of the cells to white */
    }
</style>
<style>
    #eventsTable td {
        background-color: transparent; /* Set the background color of the cells to white */
    }
    

    #suggestionsTable tbody tr td{
        justify-content: center;
        align-items: center;
    }

</style>
<div class="row mb-3 container-header">
    <div class="col-md-4">
        <h2>Client: {{ client.client_name }}</h2>
    </div>
    <div class="col-md-4">
        <h2>Status: {{ client.status}}</h2>
    </div>
    <div class="col-md-4 d-flex justify-content-end">
        <button class="btn btn-outline-primary mr-2"
                style="margin: 5px;"
                onclick="deleteClient({{ client.id }})">
                <span class="button-text">Delete</span> <i class="fas fa-trash"></i>
        </button>
        <button style="margin: 5px;" class="btn btn-outline-primary mr-2" onclick="generateLink('{{ user }}','{{ client.link }}' )">
            <span class="button-text">Link</span> <i class="fas fa-link"></i> 
        </button>
        <button style="margin: 5px;" class="btn btn-outline-primary mr-2" onclick="create_note()">
            <span class="button-text">Note</span> <i class="fas fa-sticky-note"></i>  
        </button>
        <button style="margin: 5px;" class="btn btn-outline-primary mr-2" onclick="addEvent()">
            <span class="button-text">Task</span> <i class="fas fa-calendar-plus"></i> 
        </button>
        <button style="margin: 5px;" class="btn btn-outline-primary mr-2" onclick="editClient()">
            <span class="button-text">Edit</span> <i class="fas fa-edit"></i>
        </button>
    </div>
    <script>
        function deleteClient(clientId) {
            window.location.href = '/crm/clients/delete/' + clientId + '/' ;
        }
    </script>
</div>
    
<div class="container-content">
    <div style="height: 5vh;"></div>
    <div class="row mb-12">
        <div class="col-md-4" style="text-align: center;">
            <h5>Client Info</h5>
            <p>Name: {{ client.client_name }}</p>
            <p>Status: {{ client.get_status_display }}</p>
            <p>Phone Number: {{ client.phone_number }}</p>
            <p>Email: {{ client.email }}</p>
        </div>
        <div class="col-md-4" style="text-align: center;">
            <h5>Significant life events</h5>
            <p>Born: {{ client.birthday }}</p>
            <p>Wedding Anniversary: {{ client.wedding_anniversary }}</p>
            <p>Home Anniversary: {{ client.home_anniversary }}</p>
        </div>
        <style>
            .social-link {
                text-decoration: none;
            }
        
            /* Define the color for social links with URLs */
            .social-link.with-url {
                color: #000; /* Black color for links with URLs */
            }
        
            /* Define the color for social links without URLs */
            .social-link.no-url {
                color: grey !important;
                pointer-events: none !important;
            }
        </style>
        
        <div class="col-md-4" style="text-align: center;">
            <h5>Social accounts</h5>
            <div style="padding-top: 10px;"></div>
            <!-- Facebook link -->
            <a href="{{ client.facebook_url }}" target="_blank" class="social-link{% if client.facebook_url %} with-url{% else %} no-url{% endif %}">
                <i class="fab fa-facebook" style="font-size: 3rem; text-decoration: none; margin-right: 10px;"></i>
            </a>
            
            <!-- Instagram link -->
            <a href="{{ client.instagram_url }}" target="_blank" class="social-link{% if client.instagram_url %} with-url{% else %} no-url{% endif %}">
                <i class="fab fa-instagram" style="font-size: 3rem; text-decoration: none; margin-right: 10px;"></i>
            </a>
            
            <!-- Twitter link -->
            <a href="{{ client.twitter_url }}" target="_blank" class="social-link{% if client.twitter_url %} with-url{% else %} no-url{% endif %}">
                <i class="fab fa-twitter" style="font-size: 3rem; text-decoration: none; margin-right: 10px;"></i>
            </a>
        </div>
        
        
    </div>
    <hr>
    <div style="border-radius: 10px; padding: 10px;">
        <h5 style="text-align: center;">Notes</h5>
        <div class="card-columns">
            {% for note in wishes %}
                <div class="card">
                    <div class="card-body">
                        <p class="card-text">{{ note.note }}</p>
                        <a href="#" class="btn btn-outline-primary" onclick="confirmDeleteNote('{{ note.id }}', '{{ client.id }}')" style="position: absolute; top: 5px; right: 5px;">
                            <i class="material-icons">delete</i>
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    <hr>
    <div style="border-radius: 10px;padding: 10px;">
        
        <h5 style="text-align: center;">Tasks List</h5>
        <table id="eventsTable" class="display">
            <thead>
                <tr>
                    <th>Event Type</th>
                    <th>Event Date</th>
                    <th>Event Description</th>
                    <th>Completed</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for event in events %}
                    <tr>
                        <td>{{ event.event_type }}</td>
                        <td>{{ event.event_date }}</td>
                        <td>{{ event.event_description }}</td>
                        <td>{{ event.is_completed }}</td>
                        <td>
                            
                            <a href="{% url 'edit_event' event.id %}" class="btn btn-outline-primary">
                                <i class="material-icons">edit</i> 
                            </a>
                            <a href="#" class="btn btn-outline-danger" onclick="confirmDelete('{{ event.id }}')">
                                <i class="material-icons">delete</i> 
                            </a>
                            
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <hr>
    <!-- client_events.html -->
    <div class="col-md-12 suggestionsTable_container" style="width: 100%; overflow-x: auto;">
        <table id="suggestionsTable" class="display">
            <thead>
                <tr>
                    <th class="text-center">Address</th>
                    <th class="text-center">Type</th>
                    <th class="text-center">Total room</th>
                    <th class="text-center">Bed room</th>
                    <th class="text-center">Toilet</th>
                    <th class="text-center">Square Meter</th>
                    <th class="text-center">Suggestion</th>
                    <th class="text-center">Interested</th>
                </tr>
            </thead>
           
            <tbody>
                {% for suggest in suggestions %}
                    <tr>
                        <td class="text-center">
                            <a href="{% url 'show_property' user=suggest.property.user id=suggest.property.id address=suggest.property.address %}">
                                {{ suggest.property.address }}
                            </a>
                        </td>
                        <td class="text-center">{{ suggest.property.deal_type }}</td>
                        <td class="text-center">{{ suggest.property.total_rooms }}</td>
                        <td class="text-center">{{ suggest.property.bedrooms }}</td>
                        <td class="text-center">{{ suggest.property.toilets }}</td>
                        <td class="text-center">{{ suggest.property.sqr_meter }}</td>
                        <td class="text-center">
                            <form method="post" action="{% url 'client_events' client_id=client.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="suggestion_id" value="{{ suggest.id }}">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-outline-secondary {% if suggest.is_suggested == 'suggested' %}active{% endif %} not-selected" onclick="updateSuggestion('suggested', {{ suggest.id }})">
                                        <i class="material-icons">thumb_up</i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary {% if suggest.is_suggested == 'not_suggested' %}active{% endif %} not-selected" onclick="updateSuggestion('not_suggested', {{ suggest.id }})">
                                        <i class="material-icons">thumb_down</i>
                                    </button>
                                </div>
                            </form>
                        </td>
                        <td class="text-center" style="{% if suggest.is_interested == 'interested' %}font-weight: bold; color: green;{% endif %}">
                            {{ suggest.get_is_interested_display }}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div class="input-group mb-3" style="margin-top: 20px;">
            <span class="input-group-text">Suggestion Link</span>
            <input type="text" id="generatedLink" class="form-control" value="https://estates.solutions/suggested_properties/{{ user }}/{{ client.link }}" readonly>
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard()">Copy link</button>
            </div>
        </div>
        <style>
            @media (max-width: 767px) {
                .input-group #generatedLink{
                    display: none;
                }
                .input-group{
                    max-width: 250px;
                }

            }
            
        </style>
    </div>
    <hr>
    <div id="map-legend">
        <h5>Properties on map</h5>
        <div class="legend-item">
            <img class="legend-image" src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png" alt="Interested">
            <div class="legend-label">Interested</div>
        </div>
        <div class="legend-item">
            <img class="legend-image" src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png" alt="Suggested">
            <div class="legend-label">Suggested</div>
        </div>
        <div class="legend-item">
            <img class="legend-image" src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png" alt="Not Suggested">
            <div class="legend-label">Not Suggested</div>
        </div>
        <style>
            #map-legend{
                display: flex;
                flex-direction: row;
            }
            .legend-item {
                display: flex;
                align-items: center;
                margin-bottom: 5px;
                margin-left: 5px;
                padding-left: 10px;
            }

            .legend-color {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                margin-right: 5px;
            }
            .legend-image{
                max-height: 25px;
            }
            .legend-label{
                padding-left: 5px;
            }
            @media (max-width: 767px)  {
                #map-legend{
                    flex-direction: column;
                }
                #map-container{
                    margin-bottom: 5vh;
                }
            }
        </style>
    </div>
    <div id="map-container" style=" height: 300px; width: 100%; margin-top: 20px;">
        <div id="map" style="height: 100%;"></div>
    </div>
    <script>
        function updateSuggestion(value, suggestionId) {
            var opposite_value = (value === 'suggested') ? 'not_suggested' : 'suggested';
            $.ajax({
                type: 'POST',
                url: '{% url "update_suggestion" %}',  // Replace with your Django URL for updating suggestions
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    suggestion_id: suggestionId,
                    is_suggested: value
                },
                success: function (data) {
                        // Update the button states based on the received data
                        var buttons = $('[onclick*="updateSuggestion(\'' + opposite_value + '\', ' + suggestionId + ')"]');
                        buttons.removeClass('active');  // Remove active class from all buttons
        
                        var button = $('[onclick*="updateSuggestion(\'' + value + '\', ' + suggestionId + ')"]');
                        button.addClass('active');  // Add active class to the clicked button
                    },
                error: function(xhr, textStatus, errorThrown) {
                    console.error('Error:', errorThrown);
                }
            });
        }
    </script>
</div>

<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>

<script>
    function goBack() {
        window.history.back();
    }
</script>
<script>
    function copyToClipboard() {
        // Select the text in the input field
        var linkInput = document.getElementById('generatedLink');
        linkInput.select();
        document.execCommand('copy');

        // Optionally, you can provide feedback to the user
        alert('URL copied to clipboard!');
    }
</script>
<script>
    jQuery.noConflict();
    jQuery(document).ready(function($) {
        
        
        
        // Your DataTables initialization code here
        $('#suggestionsTable').DataTable({
            autoWidth:true,
            initComplete: function () {
                this.api().columns().every(function () {
                    var that = this;

                    $('input', this.footer()).on('keyup change clear', function () {
                        if (that.search() !== this.value) { that.search(this.value).draw(); }
                    });
                });
            },
            responsive: {
                details: {
                    type: 'none',
                    target: 'td:not(:last-child)'
                }
            },
            columnDefs: [
                {
                    className: 'd-none d-sm-table-cell', // Hide on small screens
                    targets: [1, 2, 3, 4,5,7] // Adjust column indices based on your table structure
                }
            ],
            initComplete: function () {
                // Wrap the length selector and filter input in a container
                $('.dataTables_length, .dataTables_filter').wrapAll('<div class="datatable-controls"></div>');
                
                // Add the title element and position it in the center
                $('.datatable-controls').after('<div class="datatable-title"><h5 style="text-align: center; padding-top: 10px">Properties List</h5></div>');
            }
        });
        
    });
</script>
<script>
    jQuery.noConflict();
    jQuery(document).ready(function($) {
        // Your DataTables initialization code with the responsive option and column visibility control
        $('#eventsTable').DataTable({
            autoWidth:true,
            responsive: {
                details: {
                    type: 'column',
                    target: 'td:not(:last-child)'
                }
            },
            columnDefs: [
                {
                    className: 'd-none d-sm-table-cell', // Hide on small screens
                    targets: [0, 2] // Adjust column indices based on your table structure
                }
            ]
            
        });
    });
</script>
<script>

    function addEvent() {
        // Replace this line with your actual logic to navigate to the add_event page
        window.location.href = '{% url "add_event" %}';

        // Also, fill the participant_buyer field with the client's name
        document.getElementById('id_participant_buyer').value = '{{ client.client_name }}';
    }
    function create_note() {
        // Replace this line with your actual logic to navigate to the add_event page
        window.location.href = "{% url 'add_client_notes' client.id %}";
    }

    function editClient() {
        // Add your logic for handling the "Edit" button click
        window.location.href = "{% url 'edit_client' client.id %}";

        // Also, fill the participant_buyer field with the client's name
        document.getElementById('id_participant_buyer').value = '{{ client.id }}';
    }
</script>
<script>
    // Use jQuery.noConflict() to avoid conflicts with other libraries
    function confirmDelete(eventId) {
    const isConfirmed = window.confirm('Are you sure you want to delete this event?');

    if (isConfirmed) {
        fetch(`/crm/events/delete/${eventId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            // Additional options like body for POST requests can be added here
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            location.reload();
        })
        .catch(error => {
            alert('Error deleting event.');
        });
    }
}
</script>
<script>
    function confirmDeleteNote(note_id, client_id) {
        const isConfirmed = window.confirm('Are you sure you want to delete this note?');

        if (isConfirmed) {
            fetch(`/crm/events/delete_notes/${note_id}/${client_id}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                // Additional options like body for POST requests can be added here
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                location.reload();
            })
            
        }
    }
</script>
<script>
    function generateLink(user, clientLink) {
        var url = `/suggested_properties/${user}/${clientLink}`;
        window.location.href = url;
    }
</script>

{{ interested_map|json_script:"interested_json"}}
{{ suggested_map|json_script:"suggested_json"}}
{{ rest_map|json_script:"rest_json"}}

<script>
    function submitForm(interest, suggestion_id) {
        event.stopPropagation();
        var form = $('#likeForm');
        var url = form.data('url');
        var opposite_interested = (interest === 'interested') ? 'not_interested' : 'interested';

        $.ajax({
            type: 'POST',
            url: url,
            data: {
                csrfmiddlewaretoken: form.find('[name=csrfmiddlewaretoken]').val(),
                suggestion_id: suggestion_id,
                is_interested: interest
            },
            success: function (data) {
                // Update the button states based on the received data
                var buttons = $('[onclick*="submitForm(\'' + opposite_interested + '\', ' + suggestion_id + ')"]');
                buttons.removeClass('active');  // Remove active class from all buttons

                var button = $('[onclick*="submitForm(\'' + interest + '\', ' + suggestion_id + ')"]');
                button.addClass('active');  // Add active class to the clicked button
            },
        });
    }
</script>

<script>
    var map = L.map('map');
    var tileLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    // Parse location data
    let interestedLocations = JSON.parse(document.getElementById('interested_json').textContent);
    let suggestedLocations = JSON.parse(document.getElementById('suggested_json').textContent);
    let restLocations = JSON.parse(document.getElementById('rest_json').textContent);
    
    var markers = [];

    // Function to create markers for a specific location group
    function createMarkers(locations, icon) {
        locations.forEach(location => {
            if (location.property__id) {
                var markerIcon = new L.Icon({
                    iconUrl: icon.options.iconUrl,
                    shadowUrl: icon.options.shadowUrl,
                    iconSize: icon.options.iconSize,
                    iconAnchor: icon.options.iconAnchor,
                    popupAnchor: icon.options.popupAnchor,
                    shadowSize: icon.options.shadowSize
                });

                var marker = L.marker([location.property__latitude, location.property__longitude], { icon: markerIcon });
                var popupContent = "<b>Address:</b> " + location.property__address + "<br>" +
                    "<b>Deal:</b> " + location.property__deal_type + "<br>" +
                    "<b>Type:</b> " + location.property__property_type + "<br>" +
                    "<b>Total rooms:</b> " + location.property__total_rooms + "<br>" +
                    "<a href='/path/to/property/" + location.property__id + "'>Show more</a>";

                marker.bindPopup(popupContent);
                markers.push(marker);

                // Set the correct icon for each marker
                marker.setIcon(markerIcon);
            }
        });
    }

    // Create custom marker icons with different colors
    var interestedIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var suggestedIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    var restIcon = new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    // Create markers for each location group with different colors
    createMarkers(interestedLocations, interestedIcon);
    createMarkers(suggestedLocations, suggestedIcon);
    createMarkers(restLocations, restIcon);

    // Create a feature group from the markers and add it to the map
    var markerGroup = L.featureGroup(markers).addTo(map);

    // Fit the map view to the bounds of the marker group
    map.fitBounds(markerGroup.getBounds());
</script>
    


{% endblock %}
