<!DOCTYPE html>
<html lang="en">
{% load static %}
{% load socialaccount %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:400,500,700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const loadingIndicator = document.getElementById('loading-indicator');

            // Show loading indicator when the DOM content is loaded
            loadingIndicator.style.display = 'block';

            // Add an event listener for the full page load
            window.addEventListener('load', function () {
                // Full page is loaded, hide the loading indicator
                loadingIndicator.style.display = 'none';
            });

            // Your other scripts and logic go here...
        });
    </script>
    <style>
        /* Loading spinner styles */
        #loading-indicator {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 26, 0.7); /* Semi-transparent #1a1a1a background */
            z-index: 999999999;
        }

        .spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid #f3f3f3; /* Light CCCCCC */
            border-top: 4px solid #000; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite; /* Spin animation */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <title>{% block title %}Estates Solutions CRM{% endblock %}</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: space-between;
            flex-direction: column;
            overflow: hidden;
        }
        * {
            box-sizing: border-box;
        }
        
        html {
            cursor: default; /* 1 */
            font-family:
                system-ui,
                /* macOS 10.11-10.12 */ -apple-system,
                /* Windows 6+ */ Segoe UI,
                /* Android 4+ */ Roboto,
                /* Ubuntu 10.10+ */ Ubuntu,
                /* Gnome 3+ */ Cantarell,
                /* KDE Plasma 5+ */ Noto Sans,
                /* fallback */ sans-serif,
                /* macOS emoji */ "Apple Color Emoji",
                /* Windows emoji */ "Segoe UI Emoji",
                /* Windows emoji */ "Segoe UI Symbol",
                /* Linux emoji */ "Noto Color Emoji"; /* 2 */
            font-size: 14px;
            overflow: hidden;
            line-height: 1.15; /* 3 */
            -moz-tab-size: 4; /* 4 */
            tab-size: 4; /* 4 */
            -ms-text-size-adjust: 100%; /* 5 */
            -webkit-text-size-adjust: 100%; /* 5 */
            word-break: break-word; /* 6 */
        }

        .navbar {
            background-color: transparent;
            font-weight: bold;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .navbar a {
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
            text-decoration: none;
            width: 100%;
            display: block;
            
        }
        .navbar-nav {
            width: 100%;
            text-align: center; /* Center-align the text */
        }

        .navbar-nav .nav-link {
            display: inline-flex; /* Make it a flex container */
            /* margin-left: 20px; */
            transition: color 0.3s;
            text-align: center; /* Center-align the text within the link */
        }
        .navbar-nav .active{
            color: #ccc !important;
        }
        .navbar-nav .active span{
            color: #ccc !important;
        }
        .navbar-nav a, span{
            color: #444444 !important;

        }
        .navbar-nav a{
            padding-left: 1vw !important;
        }
        .navbar-nav span{
            padding-left: 5px;
        }

        .navbar-nav .nav-item.dropdown:hover .dropdown-menu {
            display: block;
        }

        .navbar-nav .nav-item.dropdown .dropdown-menu {
            display: none;
        }

        .navbar-nav .nav-item.dropdown .dropdown-item {
            opacity: 0;
            transition: opacity 0.3s;
        }

        .navbar-nav .nav-item.dropdown:hover .dropdown-item {
            opacity: 1;
        }

        .nav-link.website-name {
            font-size: 2rem;
            font-weight: bold;
            color: #ccc; /* Choose your desired text color */
            align-self: center;
            align-items: center;
        }
        
        .navbar-container {
            flex: 0 0 250px; /* Set a fixed width for the navbar container */
            height: 90vh;
        }

        .modal-content{
            background-color: #1a1a1a;
        }
        .modal-content label{
            background-color: #1a1a1a;
        }
        .modal-header span{
            background-color: #1a1a1a;
        }

        .modal-content select, 
        input,
        textarea,
        .form-control{
            background-color: transparent;
        }
        .form-control {
            color: #CCC;
            background-color: #1a1a1a;
            border: 1px solid #CCC; /* Optional: Add a border for better visibility */
        }

        .form-control:focus {
            color: #1a1a1a;
            background-color: #1a1a1a;
            border: 1px solid #CCC; /* Optional: Adjust or remove the border as needed */
            box-shadow: 0 0 0 2px #CCC;
        }
        
        .container-header {
            top: 70px;
            left: 9vw;
            position: fixed;
            padding-bottom: 10px;
            padding-top: 10px;
            width: 90vw;
            background-color: transparent;
            z-index: 555;
            border-bottom: #2b2b2b 1px solid;
        }

        .container-content {
            margin-top: 10vh;
            /* margin-right: 30px; */
            height: 80vh;
            display: block;
            flex-grow: 1;
            scroll-behavior: auto;
            overflow-y: auto;
            overflow-x: hidden;
            flex-grow: 1; /* Allow the container to grow and take up available space */
            padding-right: 10px;
        }

        /* Media query for mobile screens (max-width: 767px) */
        @media (max-width: 767px) {
            .navbar-container {
                height: 8vh;
                position: fixed;
                bottom: 6vh;
                width: 100%;
                z-index: 1000;
                left: 0;
                border-top: 1px solid #2b2b2b;
                background-color: transparent;
            }
            html, body{
                overflow: hidden !important;
            }
            
            .navbar-nav {
                flex-direction: row; /* Display links horizontally on small screens */
                justify-content: space-evenly;
            }

            .navbar-nav .nav-link {
                width: 100%; /* Allow links to take the necessary width */
                text-align: center; /* Center the text */
                justify-content: center;
                align-items: center;
                margin: 0;
                padding: 0;
                margin-top: 5px;
            }
            header .col-md-4{
                display: none;
            }
            .container-header {
                top: 0;
                left: 0;
                width: 100%;
                justify-content: center;
                text-align: center;
                background-color: #1a1a1a;
            }

            .container-content{
                margin-top: 80px;
                height: 75vh;
                width: 100%;
                display: block;
                flex-grow: 1;
                scroll-behavior: auto;
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            .search-container{
                z-index: 1000;
                margin-left: 10px;
            }
            .search-results-container{
                width: 50vw;
            }
            .notification-container{
                z-index: 100000000;
            }
            #bell-icon{
                margin-top: 0;
            }
            .modal {
                margin-top: 20vw !important;
                width: 95%;
            }
            .modal-body{
                height: 70vh;
                overflow-y: auto;
                overflow-x: hidden;
            }
            .container-fluid{
                height: 90vh;
            }
            .contents{
                width: 100vw !important;
            }
        }

        @media (max-width: 1200px) {
            .button-text{
                display: none;
            }
        }

        @media (max-width: 1650px) {
            .nav-link span {
                display: none; /* Hide text on screens smaller than 1500px */
            }
        }

        @media (min-width: 767px) and (max-width: 1650px) {
            .navbar-container{
                width: 66px;
            }
        }
        .nav-link.website-name h4{
                font-size: 1.2rem;
        }
        .nav-link.website-name h6{
            font-size: 1rem;
        }
        @media (min-width: 990px) and (max-width: 1350px) {
            .nav-link.website-name h4{
                font-size: 0.8rem;
            }
            .nav-link.website-name h6{
                font-size: 0.6rem;
            }
        }

        /* Targeting the scrollbar track */
        .container-content::-webkit-scrollbar {
            width: 12px; /* Adjust the width of the scrollbar */
            margin-right: -12px; /* Move the scrollbar to the left by its width */
        }

        /* Targeting the scrollbar handle or thumb */
        .container-content::-webkit-scrollbar-thumb {
            background-color: #CCCCCC; /* Color of the scrollbar thumb */
            border-radius: 6px; /* Radius of the scrollbar thumb corners */
        }

        /* Optional: Hover effect on the scrollbar handle */
        .container-content::-webkit-scrollbar-thumb:hover {
            background-color: #CCCCCC; /* Color when hovering over the scrollbar thumb */
        }

        /* Targeting the scrollbar track when handle is being dragged */
        .container-content::-webkit-scrollbar-thumb:active {
            background-color: #CCCCCC; /* Color when scrollbar thumb is being dragged */
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a1a1a;
            color: #ccc ;
        }
        
        input,
        select,
        label,
        option,
        select
        {
            color: #ccc ;
            background-color: #1a1a1a;
        }
        select{
            color: #ccc !important;
        }
        input::placeholder{
            color: #CCC;
        }
        input{
            color: #CCC !important;
        }
        input:hover,
        input:focus {
            /* Style for input on hover and focus */
            color: #1a1a1a;
            border: 1px solid #CCC;
            background-color: #1a1a1a;
        }

        body.dark-theme input{
            background-color: #1a1a1a;
        }
        .select2 span span{
            background-color: transparent !important;
        }
        .select2 option{
            background-color: transparent !important;
        }
        
        .btn-outline-primary{
            color: #ccc;
            border: 1px solid #ccc;
        }
        .btn-outline-primary span{
            color: #ccc ;
        }

        .btn-outline-primary:hover{
            background-color: #ccc;
            color: #000 ;
            border: 1px solid #ccc;
        }
        .btn-outline-secondary{
            color: #CCC;
            border: 1px solid #CCC;
        }

        .btn-outline-secondary:hover{
            background-color: #CCC;
            color: #1a1a1a;
            border: 1px solid #CCC;
        }
        table thead tr{
            border-color: #ccc !important;
        }

        .btn-outline-danger{
            background-color: transparent;
            color: #ccc;
            border: 1px solid #ccc;
        }
        .btn-outline-danger span{
            color: #ccc ;
        }
        .btn-outline-danger:hover{
            color: #ccc;
            background-color: #ccc;
            color: #000;
            border-color: #ccc;
        }
        
        .btn-outline-danger:hover{
            color: #ccc;
            background-color: #ccc;
            color: #000;
            border-color: #ccc;
        }
        
        
        .notification-results-container ul,
        .option,
        .search-results-container ul{
            background-color: #000;
            color: #ccc;
        }
        .container-header button span{
            transition-duration: 0.15s;
            padding-left: 5px;
            border-radius: 5px;
        }
        .container-header button:hover span{
            background-color: transparent;
            color: #000;
        }
        
        header{
            border-bottom: 1px solid #2b2b2b;
        }
        header .col-md-4{
            border-left: 1px solid #2b2b2b;
        }
        .container-fluid .navigations{
            border-right: 1px solid #2b2b2b;
            height: 100%;
        }
        .container-fluid{
            padding-right: 0;
        }
        .card{
            background-color: transparent;
            width: 100%;
            border: #2b2b2b 1px solid;
            justify-content: center;
            align-items: center;
        }
        tfoot,tr,td{
            background-color: transparent !important;
        }
        .leaflet-container{
            background-color: #1a1a1a;
        }
        .leaflet-layer,
        .leaflet-control-zoom-in,
        .leaflet-control-zoom-out,
        .leaflet-control-attribution,
        .leaflet-popup-content-wrapper {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        .leaflet-popup-content a{
            background-color: #1a1a1a !important;
        }
        textarea:focus:not(:placeholder-shown) {
            background-color: #1a1a1a;
            color: #ccc;
        }
        .dataTable_info{
            color: #ccc !important;
        }


    </style>
</head>
<div id="loading-indicator">
    <div class="spinner"></div>
</div>

<body class="d-flex flex-column h-100">
    <header>
            <div class="row">
                <div class="col-md-1 d-flex align-items-center justify-content-center" style="margin-right: 8.333px;">
                    <a class="nav-link website-name d-none d-lg-block" href="{% url 'dashboard' %}" style="margin-top: 0px;">
                        <h4 style="margin-bottom: 0;">Estates.</h4>
                        <h6>Solutions</h6>
                    </a>
                </div>
                
                <div class="col-md-8 search-container">
                    <div class="input-container">
                        <input type="text" name="query" id="search-input" autocomplete="off" placeholder="Search">
                        <button id="clear-button" class="clear-button">
                            <span class="material-icons">clear</span>
                        </button>
                    </div>
                    <div id="search-results-container" class="search-results-container"></div>
                </div>
                
                <div class="notification-container">
                    <span class="material-icons" id="bell-icon">notifications_none</span>
                    <span class="badge" id="notification-count">0</span>
                    <div id="notification-results-container" class="notification-results-container"></div>
                </div>
                
                <style>
                    .search-container {
                        margin-top: 10px;
                    }
                
                    .input-container {
                        position: relative;
                        width: 30vw;
                        
                    }
                
                    .input-container input {
                        width: 100%;
                        padding-left: 10px; /* Set left padding for text inside the input */
                        border-radius: 25px;
                        border: 1px solid #aaa;
                        height: 35px;
                        box-sizing: border-box;
                    }
                
                    .input-container input:focus {
                        border-color: #bad6fe solid 1px;
                        box-shadow: #bad6fe solid 1px;
                    }
                
                    #search-results-container {
                        margin-top: 5px;
                        position: absolute;
                        width: 30vw;
                        z-index: 1111111111;
                        background-color: #1a1a1a;
                        color: #f5f6fa;
                        border-radius: 8px;
                        max-height: 300px;
                        overflow: auto;
                    }
                
                    #search-results-container ul {
                        list-style: none;
                        padding: 0;
                        margin: 0;
                    }
                
                    #search-results-container li {
                        position: relative;
                        padding-left: 20px;
                        margin-bottom: 5px;
                        cursor: pointer;
                    }
                    #search-results-container li:hover {
                        color: #3498db;
                    }
                
                    #search-results-container li::before {
                        content: '\00a0'; 
                        font-family: 'Material Icons';
                        font-weight: 900;
                        color: #CCCCCC;
                    }
                    /* Targeting the scrollbar track */
                    #search-results-container::-webkit-scrollbar {
                        width: 12px; /* Adjust the width of the scrollbar */
                        margin-right: -12px; /* Move the scrollbar to the left by its width */
                    }

                    /* Targeting the scrollbar handle or thumb */
                    #search-results-container::-webkit-scrollbar-thumb {
                        background-color: #CCCCCC; /* Color of the scrollbar thumb */
                        border-radius: 20px; /* Radius of the scrollbar thumb corners */
                    }

                    /* Optional: Hover effect on the scrollbar handle */
                    #search-results-container::-webkit-scrollbar-thumb:hover {
                        background-color: #CCCCCC; /* Color when hovering over the scrollbar thumb */
                    }

                    /* Targeting the scrollbar track when handle is being dragged */
                    #search-results-container::-webkit-scrollbar-thumb:active {
                        background-color: #CCCCCC; /* Color when scrollbar thumb is being dragged */
                    }
                    .clear-button {
                        position: absolute;
                        right: 5px;
                        padding-top: 5px;
                        top: 50%;
                        transform: translateY(-50%);
                        border: none;
                        background: none;
                        cursor: pointer;
                        display: none;
                    }
                    .noResultsMessage{
                        padding-top: 20px;
                        padding-left: 20px;

                    }
                    td, tr{
                        background-color: transparent !important;
                    }
                    tr .sorting_1{
                        background-color: transparent !important;
                    }
                    table td, th{
                        color: #ccc;
                    }
                </style>
                <style>
                    .notification-container {
                        position: absolute;
                        top: 0;
                        right: 0;
                        margin-right: 10px;
                        margin-top: 5px;
                        width: 50px;
                        height: 45px;
                        justify-content: center;
                        align-items: center;
                        border-radius: 15px;
                    }
                    #bell-icon{
                        margin-top: 10px;
                        margin-right: 50px;
                        color: #CCC !important;
                    }
                    
                    .notification-container:hover #bell-icon{
                        border: 1px solid #1a1a1a;
                        background-color: transparent;
                        border-radius: 10px;
                    }
                    
                    .badge {
                        position: absolute;
                        top: 0;
                        right: 0;
                        margin-right: 2px; /* Adjust as needed */
                        margin-top: 5px; /* Adjust as needed */
                        font-size: 10px; /* Adjust as needed */
                        color: #CCC !important;
                    }
                    .notification-results-container{
                        display: none;
                        max-height: 280px;
                        max-width: 300px;
                        width: 300px;
                        position: absolute;
                        right: 20px;
                        top: 25px;
                        z-index: 11111111;
                        background-color: #000;
                        color: #f5f6fa;
                        border-radius: 8px;
                        margin-top: 20px;
                        overflow: auto;
                    }
                    .notification-results-container li {
                        padding-bottom: 10px;
                        padding-top: 10px;
                        padding-right: 10px;
                        cursor: pointer;
                    }
                    
                    #notification-results-container li:hover {
                        color: #3498db;
                    }
                    
                    #read-all-button{
                        border-radius: 5px;
                    }
                    
                    /* Targeting the scrollbar track */
                    #notification-results-container::-webkit-scrollbar {
                        width: 12px; /* Adjust the width of the scrollbar */
                        margin-right: -12px; /* Move the scrollbar to the left by its width */
                    }

                    /* Targeting the scrollbar handle or thumb */
                    #notification-results-container::-webkit-scrollbar-thumb {
                        background-color: #CCCCCC; /* Color of the scrollbar thumb */
                        border-radius: 20px; /* Radius of the scrollbar thumb corners */
                    }

                    /* Optional: Hover effect on the scrollbar handle */
                    #notification-results-container::-webkit-scrollbar-thumb:hover {
                        background-color: #CCCCCC; /* Color when hovering over the scrollbar thumb */
                    }

                    /* Targeting the scrollbar track when handle is being dragged */
                    #notification-results-container::-webkit-scrollbar-thumb:active {
                        background-color: #CCCCCC; /* Color when scrollbar thumb is being dragged */
                    }
                </style>
            </div>
    </header>
    <script>
        const searchInput = document.getElementById('search-input');
        const resultsContainer = document.getElementById('search-results-container');
      
        searchInput.addEventListener('input', function () {
          const query = this.value.trim();
      
          if (query.length > 0) {
            fetch(`/crm/ajax-search/?query=${query}`)
              .then(response => response.json())
              .then(data => {
                displayResults(data.results);
              })
              .catch(error => console.error('Error fetching search results:', error));
          } else {
            clearResults();
          }
        });
      
        function displayResults(results) {
          clearResults();
      
          if (results.length > 0) {
            const resultList = document.createElement('ul');
      
            results.forEach(result => {
              const listItem = document.createElement('li');
              listItem.textContent = `${result.type}: ${result.name}` ;
              listItem.setAttribute('data-links', result.links);
              listItem.setAttribute('data-id', result.ids);
              listItem.addEventListener('click', navigateToResult);
              resultList.appendChild(listItem);
            });
      
            resultsContainer.appendChild(resultList);
          } else {
            const noResultsMessage = document.createElement('p');
            noResultsMessage.textContent = 'No results found.';
            noResultsMessage.setAttribute('class','noResultsMessage')
            resultsContainer.appendChild(noResultsMessage);
          }
        }
        
            // Click away event
        $(document).on('click', function(event) {
            if (!$(event.target).closest('#search-input').length && !$(event.target).closest('#search-results-container').length) {
                clearResults();
            }
        });

        // Esc key event
        $(document).on('keydown', function(event) {
            if (event.key === 'Escape') {
                clearResults();
            }
        });

        function clearResults() {
          while (resultsContainer.firstChild) {
            resultsContainer.removeChild(resultsContainer.firstChild);
          }
        }
      
        function navigateToResult(event) {
            const resultLinks = event.target.getAttribute('data-links');  // assuming 'data-links' is the attribute name
            window.location.href = `/crm${resultLinks}`; 
        }
        
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('search-input');
            const clearButton = document.getElementById('clear-button');
            const resultsContainer = document.getElementById('search-results-container');
            console.log('triggered DOM')
            function toggleClearButton() {
                clearButton.style.display = searchInput.value.length > 0 ? 'block' : 'none';
            }
    
            clearButton.addEventListener('mousedown', function(event) {
                // Prevent the button from submitting a form (if it's inside a form)
                event.preventDefault();
                searchInput.value = '';
                clearButton.style.display = 'none';
                resultsContainer.removeChild(resultsContainer.firstChild);
            });
    
            searchInput.addEventListener('input', toggleClearButton);
            searchInput.addEventListener('focus', toggleClearButton);
            searchInput.addEventListener('blur', function() {
                clearButton.style.display = 'none';
            });
        });
    </script>
    <script>
        
        $(document).ready(function() {
            const resultsContainer = $('#notification-results-container');

            function fetchNotifications() {
                $.ajax({
                    url: '/crm/notifications/',
                    type: 'GET',
                    success: function(data) {

                        displayResults(data.notifications);
                    },
                    error: function(error) {
                        console.log('Error fetching notifications:', error);
                    }
                });
            }

            function show_numbers(){
                $.ajax({
                    url: '/crm/notifications/',
                    type: 'GET',
                    success: function(data) {
                        // Update the notification count
                        var notificationCount = data.notifications.length;
                        if (notificationCount > 9) {
                            $('#notification-count').text('9+');
                        } else {
                            $('#notification-count').text(notificationCount);
                        }

                    },
                    error: function(error) {
                        console.log('Error fetching notifications:', error);
                    }
                });
            }

            function displayResults(results) {
                clearResults();
                const resultList = document.createElement('ul');
                const header = document.createElement('div');
                header.innerHTML = `
                    <h5 style='margin-top: 10px'> Recent Notifications</h5>
                    <button style='width:80%' id='read-all-button' > Read all </button>
                    <hr>
                `
                const  readAllButton = header.querySelector('#read-all-button');
                readAllButton.addEventListener("click", markAllNotificationsAsRead)
                resultList.appendChild(header);

                if (results.length > 0) {

                    results.forEach(result => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <p data-id="${result.notification_id}" data-links="${result.client_ids}">${result.messages}</p>
                            <p data-id="${result.notification_id}" class="timestamp" data-links="${result.client_ids}">${result.timestamps}</p>
                        `;
                        listItem.setAttribute('data-links', result.client_ids);
                        listItem.setAttribute('data-id', result.notification_id);
                        listItem.addEventListener('click', navigateToResult);
                        resultList.appendChild(listItem);
                    });

                    resultsContainer.append(resultList);
                } else {
                    const noResultsMessage = document.createElement('p');
                    noResultsMessage.textContent = 'No notifications found.';
                    noResultsMessage.setAttribute('class', 'noResultsMessage');
                    resultsContainer.append(noResultsMessage);
                }
            }

            function markAllNotificationsAsRead() {
                // Get CSRF token
                const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

                // Update is_seen field for all notifications via AJAX
                console.log('marking all of them as read')
                $.ajax({
                    url: '/crm/mark-all-notifications-as-read/',
                    type: 'POST',
                    headers: { 'X-CSRFToken': csrfToken },
                    success: function () {
                        // Your logic after marking all notifications as read goes here
                        console.log('Marked all notifications as read');
                        
                        // You may want to refresh or update the UI after marking all notifications
                        fetchNotifications();
                    },
                    error: function (error) {
                        console.log('Error marking all notifications as read:', error);
                    }
                });
            }
            
            function clearResults() {
                resultsContainer.empty();
            }
            function navigateToResult(event) {
                const resultLinks = event.target.getAttribute('data-links');
                const notificationId = event.target.getAttribute('data-id');
                const notificationContainer = $('#notification-results-container');

                // Get CSRF token
                const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

                // Update is_seen field via AJAX
                $.ajax({
                    url: `/crm/mark-notification-as-read/${notificationId}/`,
                    type: 'POST',
                    headers: { 'X-CSRFToken': csrfToken },  // Include CSRF token in headers
                    success: function () {
                        // Redirect to the result link
                        window.location.href = `/crm/clients/${resultLinks}`;
                    },
                    error: function (error) {
                        console.log('Error marking notification as read:', error);
                    }
                });
            }

            // Bell icon click event
            $('.notification-container').click(function() {
                // Toggle the visibility of notification container
                resultsContainer.toggle();

                // Fetch and display notifications only if container is visible
                if (resultsContainer.is(':visible')) {
                    fetchNotifications();
                }
            });
            function closeResultsContainer() {
                resultsContainer.hide();  // Hide the container
            }
            // Click away event
            $(document).on('click', function(event) {
                if (!$(event.target).closest('.notification-container').length && !$(event.target).closest('#notification-results-container').length) {
                    closeResultsContainer();
                }
            });

            // Esc key event
            $(document).on('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeResultsContainer();
                }
            });

            // Fetch notifications on page load (initially hide the container)
            show_numbers();
        });
    </script>
    
    <div class="container-fluid " >
        <!-- style="height: 100%; min-height: 100vh; position: inherit;" -->
        <div class="row">
            <div class="navigations" style="height: 100%; width: 8vw;">
                <!-- flex: 0 0 auto;left: 0;top: 10;   -->
                <!-- Sidebar/Navbar -->
                <div class="navbar-container">
                    <nav class="navbar navbar-light mb-3 flex-column">
                        <!-- Navbar links -->
                        <div class="navbar-nav">
                            <a class="nav-link d-flex align-items-center" href="{% url 'events_list' %}">
                                <i class="material-icons mr-2">event</i>
                                <span >Schedule</span>
                            </a>
                            <a class="nav-link d-flex align-items-center" href="{% url 'client_list' %}">
                                <i class="material-icons mr-2">person</i>
                                <span >Contacts</span>
                            </a>
                            <a class="nav-link d-flex align-items-center" href="{% url 'properties_list' %}">
                                <i class="material-icons mr-2">house</i>
                                <span >Properties</span>
                            </a>
                            <a class="nav-link d-flex align-items-center logout-button" href="{% url 'settings' %}">
                                <i class="material-icons mr-2">settings</i>
                                <span >Settings</span>
                            </a>
                            <a class="nav-link d-flex align-items-center" href="{% url 'accounts:logout' %}">
                                <i class="material-icons mr-2">exit_to_app</i>
                                <span >Logout</span>
                            </a>
                        </div>
                    </nav>
                </div>
            </div>
            <div class="contents" style="width: 91vw;">
                <!-- Main content -->
                <div class="content flex-grow-1" >
                    <div class="form-container">
                        <!-- Your content goes here -->
                        {% block content %}
                        {% endblock %}
                    </div>
                </div>
            </div>
        </div>
    </div>



    
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function() {
            // Get the current URL path
            var currentPath = window.location.pathname;
        
            // Split the current URL path by '/'
            var pathSegments = currentPath.split('/');
        
            // Iterate through each navigation link
            $('.navbar-nav a').each(function() {
                var linkPath = $(this).attr('href');
        
                // Split the link URL path by '/'
                var linkSegments = linkPath.split('/');
        
                // Check if the first two segments of the current link match the current URL
                if (linkSegments.length >= 3 && pathSegments.length >= 3 &&
                    linkSegments[1] === pathSegments[1] && linkSegments[2] === pathSegments[2]) {
                    $(this).addClass('active');
                }
            });
        });
    </script>
        
</body>

</html>
